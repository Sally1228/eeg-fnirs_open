# Auditory Oddball Task 方法学

## 1. 实验范式设计

### 1.1 任务概述

采用主动听觉 oddball 范式（Active Auditory Oddball Task），被试需要对不同频率的声音刺激做出按键反应。

### 1.2 刺激参数

| 参数 | 值 |
|------|-----|
| 标准刺激（Common） | 500 Hz 纯音 |
| 偏差刺激（Oddball） | 1000 Hz 纯音 |
| 刺激持续时间 | 0.5 s |
| 刺激间隔（ISI） | 1.5 s |
| 总试次数 | 184 次 |
| 标准刺激次数 | 144 次（约78.3%） |
| 偏差刺激次数 | 40 次（约21.7%） |

### 1.3 实验结构

- **Block数量**: 8 个block
- **每block试次**: 23次（18次标准刺激 + 5次偏差刺激）
- **Block间隔**: 20 s

### 1.4 反应要求

被试使用右手操作鼠标进行反应：
- 听到**标准音（500Hz）** → **鼠标左键**
- 听到**偏差音（1000Hz）** → **鼠标右键**

---

## 2. 数据采集

### 2.1 EEG数据采集

- **采样率**: 原始1000 Hz，后降采样至256 Hz
- **电极配置**: 64导电极
- **参考电极**: A1、A2（双侧乳突）

### 2.2 fNIRS数据采集

- **采样率**: 11 Hz
- **设备类型**: 基于SNIRF标准格式
- **测量通道**: 包含多个Source-Detector配对
- **感兴趣区域（ROI）**:
  - **前额叶皮层（PFC）**: 19个通道
  - **顶叶区域（Parietal）**: 4个通道
  - **颞叶区域（Temporal）**: 14个通道

---

## 3. EEG数据预处理

### 3.1 处理流程概述

EEG数据预处理采用EEGLAB和ERPLAB工具箱，包含14个标准化处理步骤：

```
原始数据 → 降采样 → 重参考 → 高通滤波 → ICA → 伪迹去除 → 分段 → ERP平均
```

### 3.2 详细处理步骤

#### STEP 0: 事件标记提取（Marker Extraction）
- 从trigger通道提取event markers
- 支持多比特编码解析
- 事件定义：
  - Bin 1: Common（标准刺激）
  - Bin 2: Oddball（偏差刺激）

#### STEP 1: 数据导入与预处理
- **降采样**: 1000 Hz → 256 Hz
  > *理由*: 256 Hz已足够捕捉ERP成分（主要频率<40 Hz），同时减少计算负担
- **重参考**: 双侧乳突平均参考（A1+A2/2）
  > *理由*: 乳突参考是ERP研究的标准方法，有利于P300等认知成分的提取
- **高通滤波**: 0.1 Hz（去除直流漂移）
- **陷波滤波**: 50 Hz（去除工频干扰）：工频对图像影响比较大， 在这里先滤掉

#### STEP 2: ICA准备
- 使用滑动窗口进行连续伪迹检测
- 标记噪声段供ICA排除
- 参数配置见 `ICA_Prep_Values_audi.xlsx`

#### STEP 3: 独立成分分析（ICA）
- 算法: 默认使用runica算法
- 目的: 分解EEG信号为独立成分，便于后续眼电和肌电伪迹识别

#### STEP 4: ICA成分去除
- 识别并去除以下伪迹成分:
  - 眼动伪迹（眨眼、眼球运动）：主要去除眼动伪差
  - 肌电伪迹
  - 其他非脑源性活动
- 坏导插值: 根据 `Interpolate_Channels_audi.xlsx` 配置

#### STEP 5: 事件列表与分段
- 创建事件列表（Event List）
- 定义实验条件Bins
- **分段窗口**: -200 ms 至 +800 ms（相对于刺激呈现）
  > *理由*: -200ms用于基线校正，+800ms足以覆盖P300成分（通常出现在300-500ms）

#### STEP 6: 伪迹剔除
- **幅度阈值**: 基于个体数据动态设定
- **梯度检测**: 检测突变伪迹
- 参数配置见 `AR_Parameters_for_*.xlsx`
  - MW_CRAP: 移动窗口伪迹检测参数
  - SVT_CRAP: 步进电压阈值参数

#### STEP 7-8: ERP平均与可视化
- 对每个被试、每种条件分别计算ERP平均
- 生成单被试ERP波形图

#### STEP 9-11: 组平均与地形图
- 计算大组平均ERP（Grand Average）
- 绘制头皮分布地形图

#### STEP 12: ERP测量
- **P300成分提取**:
  - **时间窗口**: 300-500 ms
  - **基线窗口**: -200-0 ms
  - **测量电极**: Pz
  - **测量方法**: Peak amplitude（峰值幅度）
  - **极性**: Positive（正向成分）

> *理由*: P300是oddball范式的核心电生理指标，反映目标刺激检测和注意资源分配过程

#### STEP 13-14: 统计与行为数据
- ERP指标分布可视化
- 从E-Prime数据提取反应时（RT）和正确率

### 3.3 输出结果

- 各被试预处理后的EEG数据（.set格式）
- 事件列表文件（*_Eventlist.txt, *_Eventlist_Bins.txt）
- ERP测量结果（幅度、潜伏期）
- 质量控制报告

---

## 4. fNIRS数据预处理

### 4.1 处理流程概述

fNIRS数据预处理基于Homer3工具箱框架，包含6个主要步骤：

```
原始强度 → 光密度转换 → 运动伪迹校正 → 带通滤波 → 血红蛋白浓度计算 → Block平均/GLM分析
```

### 4.2 详细处理步骤

#### STEP 1: 预处理（Preprocessing）

**1.1 数据加载**
- 加载原始SNIRF格式数据
- 提取光强度信号和刺激标记

**1.2 运动伪迹检测与校正**
采用两阶段运动伪迹处理：

*阶段1: TDDR算法*
- **方法**: Temporal Derivative Distribution Repair (TDDR)
- **原理**: 基于时间导数的动态回归方法，自动检测和修复运动伪迹
- **参考文献**: Fishburn et al., 2019, NeuroImage

*阶段2: 小波校正*
- **方法**: Wavelet-based motion artifact correction
- **参数**: 使用默认小波分解层数
- **作用**: 进一步去除TDDR未完全消除的残余伪迹

**1.3 带通滤波**
- **频率范围**: 0.01 - 0.5 Hz：根据情况修改，这个范围有点宽
  
  > *理由*:
  > - 0.01 Hz高通滤波去除极低频漂移
  > - 0.5 Hz低通滤波去除心跳(~1 Hz)和呼吸(~0.3 Hz)生理噪声

**1.4 光密度转换**
- 将原始光强度信号转换为光密度（Optical Density, OD）变化

**1.5 血红蛋白浓度计算**
- 使用修正的Beer-Lambert定律（Modified Beer-Lambert Law）
- 输出指标:
  - **HbO**: 氧合血红蛋白（Oxygenated Hemoglobin）
  - **HbR**: 脱氧血红蛋白（Deoxygenated Hemoglobin）
  - **HbT**: 总血红蛋白（Total Hemoglobin = HbO + HbR）

#### STEP 2: 质量控制（QC）

**2.1 信号质量评估**
- **SCI阈值**: 0.6（Scalp Coupling Index）
  > *理由*: SCI < 0.6表示头皮-光极耦合质量差，信号不可靠
- 可视化内容:
  - 原始强度信号
  - 光密度变化
  - 处理后的OD
  - HbO/HbR时间序列
  - 运动掩码
  - SCI评分

**2.2 通道质量标记**
- `mlActAuto`: 自动标记质量不合格通道
- `tIncAuto`: 自动标记质量不合格时间点

#### STEP 3: Block平均（Block Averaging）

**3.1 分析参数**
- **Epoch窗口**: -5 s 至 +30 s（相对于block开始）
  > *理由*: 血流动力学响应延迟于神经活动5-6s，峰值约在10-15s，30s足够观察完整HRF
- **基线窗口**: -5 s 至 0 s

**3.2 输出内容**
- 各被试各ROI的block平均时间序列
- HbO和HbR的平均波形
- 统计表（blockavg_table.csv）

#### STEP 4: 一般线性模型分析（GLM）

**4.1 HRF模型**
采用Gamma函数建模血流动力学响应：
- **HRF持续时间**: 30 s
- **Gamma形状参数（Shape）**: 6
- **Gamma尺度参数（Scale）**: 1
  > *理由*: 这些参数对应于典型的HRF峰值时间约6s，与文献报道的神经血管耦合时间常数一致

**4.2 设计矩阵构建**
- **刺激回归量**: 刺激boxcar函数与HRF卷积
- **漂移校正**: 采用DCT（离散余弦变换）高通滤波
  - DCT截止频率: 1/128 Hz（约128s周期）
  > *理由*: 去除极低频信号漂移，同时保留任务相关的血流动力学响应

**4.3 GLM拟合**
- **方法**: 普通最小二乘法（OLS）：==ar-irls更好，但是使用'ar-irls'时没办法拟合，先用ols==
- **输出**:
  - Beta系数（激活强度）
  - t统计量
  - p值
  - 每个ROI和通道的统计结果

#### STEP 5-6: 组水平分析

**5.1 组Block平均**
- 合并所有被试的block平均数据
- 计算组平均时间序列（Mean ± SE）
- 单样本t检验（vs. 0）
- FDR多重比较校正（α = 0.05）

**5.2 组GLM分析**
- 合并被试级GLM结果
- 组水平统计推断
- 效应量计算（Cohen's d）

### 4.3 输出结果

- 预处理后的fNIRS数据（*_fnirs_preproc.mat）
- QC汇总表（QC_summary.csv）
- Block平均结果（*_blockavg.mat, *_blockavg_table.csv）
- GLM结果（*_glm.mat, *_glm_table.csv）
- 可视化图像

---

## 5. EEG-fNIRS神经血管耦联分析

### 5.1 分析目标

探索EEG电活动与fNIRS血流动力学响应之间的神经血管耦联（Neurovascular Coupling, NVC）关系，评估大脑功能整合性。

### 5.2 分析策略

采用四种互补的分析方法：

```
STEP 1: 组水平特征相关分析
STEP 2: EEG-informed fNIRS GLM
STEP 3: 时间延迟相关与相干性分析
STEP 4: 动态耦联分析
```

### 5.3 STEP 1: 组水平特征相关分析

#### 5.3.1 EEG特征提取

从分段后的EEG数据提取以下特征：

**P300成分特征**:
- **P300幅度**: 300-500 ms窗口内的峰值/平均幅度
- **P300潜伏期**: 峰值出现时间
- **测量电极**: Pz
- **基线校正**: -200 至 0 ms

**频带功率特征**:
- **Delta功率**: 1-3 Hz
- **Theta功率**: 4-7 Hz
- **功率窗口**: 200-500 ms

#### 5.3.2 fNIRS特征提取

使用GLM方法估计血流动力学响应强度：
- 对每种条件分别计算Beta系数
- 在各ROI（PFC、Parietal、Temporal）内平均
- 分别分析HbO和HbR响应

#### 5.3.3 分析条件

针对三种条件分别进行分析：
1. **All**: 所有听觉刺激（common + oddball）
2. **Common**: 仅标准刺激
3. **OddballCommon**: 偏差刺激与标准刺激的差异（oddball - common）

#### 5.3.4 相关分析

- 计算Pearson相关系数
- 每个EEG特征 × 每个ROI × 每种血红蛋白类型
- 统计显著性检验（t检验）
- 生成散点图可视化相关关系

### 5.4 STEP 2: EEG-informed fNIRS GLM

#### 5.4.1 基本原理

将单试次EEG P300幅度作为参数调制器（Parametric Modulator）纳入fNIRS GLM，评估神经活动变异性是否预测血流动力学响应变异性。

#### 5.4.2 EEG-fNIRS事件对齐

**对齐策略**:
1. 当EEG和fNIRS事件数量一致时，按顺序对齐
2. 当数量不一致时，使用时间匹配算法
   - 对齐容差: ±0.3 s
   - 最小匹配事件数: 5

**试次有效性判定**:
- EEG端: 基于`EEG.reject`标记排除坏试次
- fNIRS端: 事件窗口内≥80%时间点通过QC（tIncAuto）

#### 5.4.3 权重标准化

EEG P300幅度标准化方式：
- **Z-score**: 减均值、除标准差（默认）
- 目的: 使EEG调制回归量可解释，β系数反映"每单位SD EEG变化对应的fNIRS响应变化"

#### 5.4.4 设计矩阵构建

对每种分析条件构建设计矩阵：

**All分析**:
- X1: 所有刺激 × HRF（主效应）
- X2: 所有刺激 × EEG权重 × HRF（EEG调制效应）
- 截距 + DCT漂移项

**Common分析**:
- X1: 标准刺激 × HRF
- X2: 标准刺激 × EEG权重 × HRF

**OddballCommon分析**:
- X1: (Oddball - Common) × HRF
- X2: (Oddball - Common) × EEG权重 × HRF

#### 5.4.5 关键输出

- **β_EEG**: EEG调制效应系数
  > 正值表示P300越大，HbO响应越强（正向耦联）
- t统计量和p值
- 每通道和ROI的统计结果

### 5.5 STEP 3: 时间延迟相关与相干性分析

分析EEG和fNIRS信号的时间动态关系：
- 时间延迟相关（Time-lagged correlation）
- 相干性分析（Coherence analysis）
- 探索最佳耦联延迟时间

### 5.6 STEP 4: 动态耦联分析

评估神经血管耦联的时变特性：
- 滑动窗口相关分析
- 动态功能连接方法
- 耦联强度的时间变化模式

---

## 6. 统计分析

### 6.1 组水平统计

- **被试内分析**: 配对t检验（Oddball vs. Common）
- **单样本检验**: 与0比较（激活显著性）
- **相关分析**: Pearson相关

### 6.2 多重比较校正

- **方法**: FDR校正（Benjamini-Hochberg）
- **显著性水平**: α = 0.05

### 6.3 效应量

- **Cohen's d**: 用于评估激活强度
- **Pearson r**: 用于评估耦联关系强度

---

## 7. 数据处理流程图

```
                    ┌─────────────────────────────────────────┐
                    │          Active Auditory Oddball        │
                    │    (500Hz Common / 1000Hz Oddball)      │
                    └──────────────────┬──────────────────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           ▼                           │                           ▼
    ┌─────────────┐                    │                    ┌─────────────┐
    │  EEG采集    │                    │                    │ fNIRS采集   │
    │  (1000Hz)   │                    │                    │  (11Hz)     │
    └──────┬──────┘                    │                    └──────┬──────┘
           │                           │                           │
           ▼                           │                           ▼
    ┌─────────────┐                    │                    ┌─────────────┐
    │ 预处理      │                    │                    │ 预处理      │
    │ ·降采样256Hz│                    │                    │ ·TDDR+小波  │
    │ ·重参考     │                    │                    │ ·带通滤波   │
    │ ·高通滤波   │                    │                    │ ·OD→Hb转换 │
    │ ·ICA伪迹去除│                    │                    │             │
    └──────┬──────┘                    │                    └──────┬──────┘
           │                           │                           │
           ▼                           │                           ▼
    ┌─────────────┐                    │                    ┌─────────────┐
    │ 分段        │                    │                    │ Block平均   │
    │ -200~800ms  │                    │                    │ -5~30s      │
    └──────┬──────┘                    │                    └──────┬──────┘
           │                           │                           │
           ▼                           │                           ▼
    ┌─────────────┐                    │                    ┌─────────────┐
    │ ERP计算     │                    │                    │ GLM分析     │
    │ P300(Pz)    │                    │                    │ HRF建模     │
    │ 300-500ms   │                    │                    │ DCT漂移校正 │
    └──────┬──────┘                    │                    └──────┬──────┘
           │                           │                           │
           │                           ▼                           │
           │              ┌─────────────────────────┐              │
           └──────────────│   神经血管耦联分析      │──────────────┘
                          │ ·特征相关(STEP1)       │
                          │ ·EEG-informed GLM      │
                          │   (STEP2)              │
                          │ ·时延相关/相干(STEP3)  │
                          │ ·动态耦联(STEP4)       │
                          └─────────────────────────┘
```



---

## 8. 被试与数据质量

### 数据排除标准

- SCI < 0.6 的fNIRS通道被排除
- 超过伪迹阈值的EEG试次被排除
- EEG-fNIRS对齐失败的试次被排除



## 9 代码位置

```
eeg_fnirs/
├── eeg/audi/audi_EEG_ERP_Processing/scripts/     # EEG处理脚本
├── fnirs/audi/audi_fnirs_processing/             # fNIRS处理脚本
└── eeg_fnirs_processing/audi_eeg_fnirs_processing/  # 耦联分析脚本
```

